name: Type Check

on:
  push:
  pull_request:

jobs:
  typecheck:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: [3.7.17, 3.11.9]

    steps:
      - uses: actions/checkout@v4

      # Install pyenv and build dependencies
      - name: Install pyenv and build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential zlib1g-dev libssl-dev libbz2-dev \
            libreadline-dev libsqlite3-dev libffi-dev liblzma-dev \
            libncurses5-dev libncursesw5-dev libgdbm-dev uuid-dev \
            curl cmake

          curl https://pyenv.run | bash

      # Install Python versions
      - name: Install Python
        run: |
          export PYENV_ROOT="$HOME/.pyenv"
          export PATH="$PYENV_ROOT/bin:$PYENV_ROOT/shims:$PATH"

          pyenv install -s ${{ matrix.python-version }}

      # Clone and build grug-tests
      - name: Build grug-tests
        run: |
          git clone https://github.com/grug-lang/grug-tests
          cd grug-tests
          git checkout development
          cmake -S . -B build
          cmake --build build

      # Run tests
      - name: Run Pyright and Tests (Python ${{ matrix.python-version }})
        run: |
          export PYENV_ROOT="$HOME/.pyenv"
          export PATH="$PYENV_ROOT/bin:$PYENV_ROOT/shims:$PATH"

          pyenv global ${{ matrix.python-version }}
          python --version

          pip install --upgrade pip --user
          pip install pyright pytest --user

          # Extra deps for 3.7
          if [[ "${{ matrix.python-version }}" == "3.7.17" ]]; then
            pip install tomli importlib-metadata --user
          fi

          pip install -e .[dev]

          # Type check
          pyright --pythonversion ${{ matrix.python-version%%.* }}

          # Existing test runner
          python tests.py

          # grug-tests
          pytest --grug-tests-path=./grug-tests -s -v
