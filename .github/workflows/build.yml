name: Type Check

on:
  push:
  pull_request:

jobs:
  typecheck:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      # Install pyenv and build dependencies
      - name: Install pyenv and build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential zlib1g-dev libssl-dev libbz2-dev \
            libreadline-dev libsqlite3-dev libffi-dev liblzma-dev \
            libncurses5-dev libncursesw5-dev libgdbm-dev uuid-dev curl

          curl https://pyenv.run | bash

      # Install Python versions
      - name: Install Python 3.7.17 and 3.11.9
        run: |
          export PYENV_ROOT="$HOME/.pyenv"
          export PATH="$PYENV_ROOT/bin:$PYENV_ROOT/shims:$PATH"

          pyenv install -s 3.7.17
          pyenv install -s 3.11.9

      # Run on Python 3.7
      - name: Run Pyright and Examples/Tests on Python 3.7
        run: |
          export PYENV_ROOT="$HOME/.pyenv"
          export PATH="$PYENV_ROOT/bin:$PYENV_ROOT/shims:$PATH"

          pyenv global 3.7.17
          python --version

          pip install --upgrade pip --user
          pip install pyright pytest --user
          pip install tomli importlib-metadata --user
          pip install -e .[dev]

          # Type check
          pyright --pythonversion 3.7

          # Run examples
          for f in examples/*/example.py; do
            cd "$(dirname "$f")"
            python "$(basename "$f")"
            cd - > /dev/null
          done

          # Run package tests
          for f in src/grug/packages/**/tests/tests.py; do
            cd "$(dirname "$f")"
            python "$(basename "$f")"
            cd - > /dev/null
          done

      # Run on Python 3.11
      - name: Run Pyright and Examples/Tests on Python 3.11
        run: |
          export PYENV_ROOT="$HOME/.pyenv"
          export PATH="$PYENV_ROOT/bin:$PYENV_ROOT/shims:$PATH"

          pyenv global 3.11.9
          python --version

          pip install --upgrade pip --user
          pip install pyright pytest --user
          pip install -e .[dev]

          # Type check
          pyright --pythonversion 3.11

          # Run examples
          for f in examples/*/example.py; do
            cd "$(dirname "$f")"
            python "$(basename "$f")"
            cd - > /dev/null
          done

          # Run package tests
          for f in src/grug/packages/**/tests/tests.py; do
            cd "$(dirname "$f")"
            python "$(basename "$f")"
            cd - > /dev/null
          done
