name: Test

on:
  push:
  pull_request:
  schedule:
    - cron: "0 2 * * *" # nightly at 02:00 UTC

jobs:
  typecheck:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: [3.7.17, 3.11.9]

    steps:
      - uses: actions/checkout@v4

      # Install pyenv and build dependencies
      - name: Install pyenv and build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential zlib1g-dev libssl-dev libbz2-dev \
            libreadline-dev libsqlite3-dev libffi-dev liblzma-dev \
            libncurses5-dev libncursesw5-dev libgdbm-dev uuid-dev \
            curl cmake git wget

          curl https://pyenv.run | bash

      # Install Python versions
      - name: Install Python
        run: |
          export PYENV_ROOT="$HOME/.pyenv"
          export PATH="$PYENV_ROOT/bin:$PYENV_ROOT/shims:$PATH"

          pyenv install -s ${{ matrix.python-version }}

      # Clone and build grug-tests
      - name: Build grug-tests
        run: |
          git clone https://github.com/grug-lang/grug-tests
          cd grug-tests
          git checkout development
          cmake -S . -B build
          cmake --build build

      # Run tests
      - name: Run Pyright and Tests (Python ${{ matrix.python-version }})
        run: |
          export PYENV_ROOT="$HOME/.pyenv"
          export PATH="$PYENV_ROOT/bin:$PYENV_ROOT/shims:$PATH"

          pyenv global ${{ matrix.python-version }}
          python --version

          pip install --upgrade pip --user
          pip install pyright pytest --user

          if [[ "${{ matrix.python-version }}" == "3.7.17" ]]; then
            pip install tomli importlib-metadata --user
          fi

          pip install -e .[dev]

          PY_MAJOR_MINOR=$(python - <<'EOF'
          import sys
          print(f"{sys.version_info.major}.{sys.version_info.minor}")
          EOF
          )

          pyright --pythonversion "$PY_MAJOR_MINOR"

          python tests.py
          pytest --grug-tests-path=./grug-tests -s -v

      # Run AFL++ fuzzing (only on Python 3.7.17)
      - name: Run AFL++ Fuzzing
        if: matrix.python-version == '3.7.17'
        run: |
          # Install AFL++
          sudo apt-get install -y afl++

          # Silences AFL++ core dump notification complaint
          echo core | sudo tee /proc/sys/kernel/core_pattern

          # Create a tiny seed corpus
          mkdir -p in
          echo -n a > in/seed

          # Run AFL++ for 2 minutes, forcibly killed after 10s if it overhangs
          timeout --kill-after=10s 120s afl-fuzz -i in -o out -n -- python3 fuzz.py || true

          # Count crashes and hangs
          CRASH_COUNT=$(ls -1 out/crashes/id:* 2>/dev/null | wc -l)
          HANG_COUNT=$(ls -1 out/hangs/id:* 2>/dev/null | wc -l)

          echo "Crashes: $CRASH_COUNT"
          echo "Hangs: $HANG_COUNT"

          # Fail if any crash or hang
          if [ "$CRASH_COUNT" -gt 0 ] || [ "$HANG_COUNT" -gt 0 ]; then
            echo "‚ùå AFL found crashes or hangs"
            exit 1
          fi

      # Upload AFL artifacts only if there were crashes or hangs
      - name: Upload AFL artifacts
        if: failure()  # only runs if the previous step failed
        uses: actions/upload-artifact@v4
        with:
          name: afl-results
          path: out/
